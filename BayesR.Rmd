---
title: "R Notebook"
output: html_notebook
---
```{r}
source('../Simulations/LinearModel/Coefficients.R')
source('../Simulations/LinearModel/Covariates.R')
source('../Simulations/LinearModel/noise.R')
source('../Simulations/LinearModel/LinearModel.R')
library(rstan)
N=1000
M=100
Q=1
P=1
K=4
set.seed(123)
X <- covariateMatrix(N = N, M=M,covariatesVar = rep(1,M))
Z <- covariateMatrix(N=N,M = P)
E <- iidNormal(N=N,traits = Q,sdI = 0.001)
B <- replicate(
  n=Q, mixtureCoefSingle(
    M = M,proportions = rep(1/K,K),variance = 0.1*c(1e-6,1e-3,1e-2,1e-1)
    )
  )[1,]
B <- t(do.call(what = rbind,args = B))

U <- unlist(replicate(
  n=Q, mixtureCoefSingle(
    M = P,proportions = 1,variance = 0.1
    ))[1,1,])
Y <- linearModel(X = X,B = B,E = E)
Px=M
save(list=c('X','Y','U','E','B','Z'),file=c('BayesRInput.RData'))

Y=scale(Y)
Y=Y[,1]
X=scale(X)

RHS <- diag( (t(X) %*% X) ) 
LHS <- (t(X)%*%Y)
b_OLS <- LHS / RHS
# estimate effects by multiple regression
b_MR_OLS <- solve(t(X) %*% (X)) %*% (t(X) %*% Y)
plot(B[,1],B[,1],type="l",main="Bayes R Unpooled")
 points(x=B[,1],y=b_MR_OLS)
 
```
```{r}
options(mc.cores = parallel::detectCores())

modelUnpooled<- stan_model(file = "BayesRUnPooled.stan",auto_write = T)




BayesFitUnpooled<-sampling(modelUnpooled,chains=4,warmup=1000,iter=2000,control = list(max_treedepth = 10))
 #BayesFitUnpooled<-vb(modelUnpooled)
 rstan::stan_diag(BayesFitUnpooled)
 
save(list='BayesFitUnpooled',file='BayesFitUnpooled.RData')

  stan_effects<- rstan::get_posterior_mean(BayesFitUnpooled,'beta')
 plot(B[,1],B[,1],type="l",main="Bayes R Unpooled")
 points(x=B[,1],y=b_MR_OLS,pch = 23,col="yellow")
 points(x=B[,1],y=stan_effects[,1])
 points(x=B[,1],y=stan_effects[,2],col="red")
 points(x=B[,1],y=stan_effects[,3],col="blue")
 points(x=B[,1],y=stan_effects[,4],col="green")
 
 line(B[,1],B[,1])

```

```{r}
modelPooled<- stan_model(file = "BayesRPooled.stan",auto_write = T)
BayesFitPooled<-sampling(modelPooled,chains=4,warmup=500,iter=1000,control = list(max_treedepth = 10))
#BayesFitPooled<-vb(modelPooled)

 save(list='BayesFitPooled',file='BayesFitPooled.RData')
 rstan::stan_diag(BayesFitPooled)
 
 stan_effects<- rstan::get_posterior_mean(BayesFitPooled,'beta')
 
 
 ssPooled<- shinystan::as.shinystan(BayesFitPooled)
 save(list='ssPooled',file='BayesFitPooledSS.RData')
 Bl<-log(abs(B))
 b_MR_OLSl<-log(abs(b_MR_OLS))
 stan_effects<-log(abs(stan_effects))
 plot(Bl[,1],Bl[,1],type="l",main="Bayes R Pooled")
 points(x=Bl[,1],y=b_MR_OLSl,pch = 23,col="yellow")
 points(x=Bl[,1],y=stan_effects[,1])
 points(x=Bl[,1],y=stan_effects[,2],col="red")
 points(x=Bl[,1],y=stan_effects[,3],col="blue")
 points(x=Bl[,1],y=stan_effects[,4],col="green")
 line(Bl[,1],Bl[,1])
```

